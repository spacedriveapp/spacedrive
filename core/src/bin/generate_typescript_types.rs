//! Generate TypeScript types using Specta

use specta::TypeCollection;
use specta_typescript::Typescript;
use std::path::Path;

// Import the same types we use for Swift
use sd_core::domain::addressing::{SdPath, SdPathBatch};
use sd_core::infra::event::{Event, FileOperation, FsRawEventKind};
use sd_core::infra::job::{
	generic_progress::GenericProgress, output::JobOutput, progress::Progress, types::JobStatus,
};
use sd_core::library::LibraryStatistics;
use sd_core::ops::indexing::{metrics::IndexerMetrics, state::IndexerStats};
use sd_core::ops::jobs::list::output::{JobListItem, JobListOutput};
use sd_core::ops::libraries::create::{input::LibraryCreateInput, output::LibraryCreateOutput};
use sd_core::ops::libraries::list::output::LibraryInfo;
use sd_core::volume::types::{DiskType, FileSystem, MountType, VolumeFingerprint, VolumeType};

fn main() -> Result<(), Box<dyn std::error::Error>> {
	println!("ğŸ¦€â¡ï¸ğŸ“ Generating TypeScript types using Specta...");

	// Register the same comprehensive types as Swift
	let types = TypeCollection::default()
		// Core Event System - THE MAIN TYPE!
		.register::<Event>()
		// Union types (enums)
		.register::<FileOperation>()
		.register::<FsRawEventKind>()
		.register::<SdPath>()
		.register::<SdPathBatch>()
		.register::<JobOutput>()
		.register::<JobStatus>()
		.register::<Progress>()
		// Volume types
		.register::<VolumeFingerprint>()
		.register::<VolumeType>()
		.register::<DiskType>()
		.register::<FileSystem>()
		.register::<MountType>()
		// Job system types
		.register::<GenericProgress>()
		.register::<IndexerMetrics>()
		.register::<IndexerStats>()
		// Library API types
		.register::<LibraryCreateInput>()
		.register::<LibraryCreateOutput>()
		.register::<LibraryInfo>()
		.register::<LibraryStatistics>()
		// Job API types
		.register::<JobListItem>()
		.register::<JobListOutput>();

	println!("ğŸ“Š Registered {} types to export", types.len());

	// Configure TypeScript generation
	let typescript = Typescript::default()
		.header("// Generated by Spacedrive using Specta - DO NOT EDIT")
		.bigint(specta_typescript::BigIntExportBehavior::Number); // Use number for simplicity

	// Export to the TypeScript client package
	let output_path = Path::new("packages/ts-client/src/types.ts");

	// Ensure the directory exists
	if let Some(parent) = output_path.parent() {
		std::fs::create_dir_all(parent)?;
	}

	typescript.export_to(output_path, &types)?;

	println!(
		"âœ… Generated TypeScript types to: {}",
		output_path.display()
	);
	println!("ğŸ‰ Specta TypeScript generation completed!");

	// Print the generated content for inspection
	let generated_content = std::fs::read_to_string(output_path)?;
	println!("\nğŸ“„ Generated TypeScript code:\n{}", generated_content);

	Ok(())
}
