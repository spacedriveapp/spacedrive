//! Generate Swift types using Specta
//!
//! This binary uses specta to generate comprehensive Swift types
//! that properly handle both structs and union types.

use specta::TypeCollection;
use specta_swift::Swift;
use std::path::Path;

// Import the types we want to export
use sd_core::domain::addressing::{SdPath, SdPathBatch};
use sd_core::infra::event::{Event, FileOperation, FsRawEventKind};
use sd_core::infra::job::{
	generic_progress::GenericProgress, output::JobOutput, progress::Progress, types::JobStatus,
};
// use sd_core::library::config::LibraryStatistics; // Private module
use sd_core::ops::indexing::{metrics::IndexerMetrics, state::IndexerStats};
use sd_core::ops::jobs::list::output::{JobListItem, JobListOutput};
use sd_core::ops::libraries::create::{input::LibraryCreateInput, output::LibraryCreateOutput};
use sd_core::ops::libraries::list::output::LibraryInfo;
use sd_core::volume::types::{DiskType, FileSystem, MountType, VolumeFingerprint, VolumeType};

fn main() -> Result<(), Box<dyn std::error::Error>> {
	println!("ğŸ¦€â¡ï¸ğŸ Generating Swift types using Specta...");

	// Register comprehensive types for complete API coverage
	let types = TypeCollection::default()
		// Core Event System - THE MAIN TYPE!
		.register::<Event>()
		// Union types (enums)
		.register::<FileOperation>()
		.register::<FsRawEventKind>()
		.register::<SdPath>()
		.register::<SdPathBatch>()
		.register::<JobOutput>()
		.register::<JobStatus>()
		.register::<Progress>()
		// Volume types
		.register::<VolumeFingerprint>()
		.register::<VolumeType>()
		.register::<DiskType>()
		.register::<FileSystem>()
		.register::<MountType>()
		// Job system types
		.register::<GenericProgress>()
		.register::<IndexerMetrics>()
		.register::<IndexerStats>()
		// Library API types
		.register::<LibraryCreateInput>()
		.register::<LibraryCreateOutput>()
		.register::<LibraryInfo>()
		// Job API types
		.register::<JobListItem>()
		.register::<JobListOutput>();

	println!("ğŸ“Š Registered {} types to export", types.len());

	// Configure Swift generation
	let swift = Swift::new()
		.header("// Generated by Spacedrive using Specta - DO NOT EDIT")
		.naming(specta_swift::NamingConvention::PascalCase) // Swift type naming convention
		.optionals(specta_swift::OptionalStyle::QuestionMark); // Use Swift ? syntax

	// Generate Swift content
	let generated_content = swift.export(&types)?;

	// Post-process to add public visibility
	let public_content = generated_content
		.lines()
		.map(|line| {
			if line.starts_with("enum ") || line.starts_with("struct ") {
				format!("public {}", line)
			} else if line.trim().starts_with("let ") {
				// Make struct properties public too
				line.replace("let ", "public let ")
			} else {
				line.to_string()
			}
		})
		.collect::<Vec<String>>()
		.join("\n");

	// Export to the Swift client package
	let output_path = Path::new("packages/swift-client/Sources/SpacedriveClient/Types.swift");
	std::fs::write(output_path, &public_content)?;

	println!("âœ… Generated Swift types to: {}", output_path.display());
	println!("ğŸ‰ Specta Swift generation completed!");

	// Print the generated content for inspection
	println!("\nğŸ“„ Generated Swift code:\n{}", public_content);

	Ok(())
}
