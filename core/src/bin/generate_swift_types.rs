//! Generate Swift types using Specta
//!
//! This binary uses specta to generate comprehensive Swift types
//! that properly handle both structs and union types.

use specta::TypeCollection;
use specta_swift::Swift;
use std::path::Path;

// Import the types we want to export
use sd_core::domain::addressing::SdPath;
use sd_core::infra::event::{FileOperation, FsRawEventKind};
use sd_core::infra::job::{output::JobOutput, types::JobStatus};
use sd_core::ops::libraries::create::{input::LibraryCreateInput, output::LibraryCreateOutput};
use sd_core::volume::types::{DiskType, FileSystem, MountType, VolumeFingerprint, VolumeType};

fn main() -> Result<(), Box<dyn std::error::Error>> {
	println!("ğŸ¦€â¡ï¸ğŸ Generating Swift types using Specta...");

	// Register all the important union and struct types
	let types = TypeCollection::default()
		// Union types (enums)
		.register::<FileOperation>()
		.register::<FsRawEventKind>()
		.register::<SdPath>()
		.register::<JobOutput>()
		.register::<JobStatus>()
		// Volume types
		.register::<VolumeFingerprint>()
		.register::<VolumeType>()
		.register::<DiskType>()
		.register::<FileSystem>()
		.register::<MountType>()
		// Action/Query types
		.register::<LibraryCreateInput>()
		.register::<LibraryCreateOutput>();

	println!("ğŸ“Š Registered {} types to export", types.len());

	// Configure Swift generation
	let swift = Swift::new()
		.header("// Generated by Spacedrive using Specta - DO NOT EDIT")
		.naming(specta_swift::NamingConvention::PascalCase) // Swift type naming convention
		.optionals(specta_swift::OptionalStyle::QuestionMark); // Use Swift ? syntax

	// Generate Swift content
	let generated_content = swift.export(&types)?;

	// Post-process to add public visibility
	let public_content = generated_content
		.lines()
		.map(|line| {
			if line.starts_with("enum ") || line.starts_with("struct ") {
				format!("public {}", line)
			} else {
				line.to_string()
			}
		})
		.collect::<Vec<String>>()
		.join("\n");

	// Export to the Swift client package
	let output_path = Path::new("packages/swift-client/Sources/SpacedriveClient/Types.swift");
	std::fs::write(output_path, &public_content)?;

	println!("âœ… Generated Swift types to: {}", output_path.display());
	println!("ğŸ‰ Specta Swift generation completed!");

	// Print the generated content for inspection
	println!("\nğŸ“„ Generated Swift code:\n{}", public_content);

	Ok(())
}
