//! Generate Swift types using Specta and our rspc-inspired type extraction system
//!
//! This binary automatically discovers all registered operations and queries
//! and generates comprehensive Swift types for the complete Spacedrive API.

use specta::TypeCollection;
use specta_swift::Swift;
use std::path::Path;

// Import our type extraction system
use sd_core::ops::type_extraction::generate_spacedrive_api;

fn main() -> Result<(), Box<dyn std::error::Error>> {
	println!("ðŸ¦€âž¡ï¸ðŸŽ Generating Swift types using Specta + rspc-inspired type extraction...");

	// Use our automatic type extraction system to discover all operations and queries
	let (operations, queries, mut types) = generate_spacedrive_api();

	println!(
		"ðŸ” Discovered {} operations and {} queries",
		operations.len(),
		queries.len()
	);
	println!("ðŸ“Š Type collection has {} types", types.len());

	// Print discovered operations for verification
	println!("\nðŸ“‹ Discovered Operations:");
	for op in &operations {
		println!("  â€¢ {} -> {}", op.identifier, op.wire_method);
	}

	println!("\nðŸ“‹ Discovered Queries:");
	for query in &queries {
		println!("  â€¢ {} -> {}", query.identifier, query.wire_method);
	}

	// Configure Swift generation
	let swift = Swift::new()
		.header(
			"// Generated by Spacedrive using Specta + rspc-inspired type extraction - DO NOT EDIT",
		)
		.naming(specta_swift::NamingConvention::PascalCase) // Swift type naming convention
		.optionals(specta_swift::OptionalStyle::QuestionMark); // Use Swift ? syntax

	// Generate Swift content
	let generated_content = swift.export(&types)?;

	// Export to the Swift client package
	let output_path = Path::new("packages/swift-client/Sources/SpacedriveClient/Types.swift");
	std::fs::write(output_path, &generated_content)?;

	println!("âœ… Generated Swift types to: {}", output_path.display());
	println!("ðŸŽ‰ Specta Swift generation completed!");
	println!(
		"ðŸš€ All {} operations and {} queries automatically discovered and exported!",
		operations.len(),
		queries.len()
	);

	// Print a sample of the generated content for inspection
	let lines: Vec<&str> = generated_content.lines().collect();
	let sample_size = std::cmp::min(50, lines.len());
	println!(
		"\nðŸ“„ Sample of generated Swift code (first {} lines):",
		sample_size
	);
	for line in lines.iter().take(sample_size) {
		println!("{}", line);
	}
	if lines.len() > sample_size {
		println!("... ({} more lines)", lines.len() - sample_size);
	}

	Ok(())
}
